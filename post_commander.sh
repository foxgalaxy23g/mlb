#!/bin/bash
#
# –°–∫—Ä–∏–ø—Ç –¥–ª—è –∫–æ–º–ø–∏–ª—è—Ü–∏–∏ –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ –ü–û –∏ –µ–≥–æ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è 
# –≤ —Å–±–æ—Ä–æ—á–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é live-build –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–π –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –≤ –¥–∏—Å—Ç—Ä–∏–±—É—Ç–∏–≤.
#

# –ü—Ä–µ–∫—Ä–∞—â–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–∞ –ø—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –ª—é–±–æ–π –æ—à–∏–±–∫–∏
set -e

# --- –û–°–ù–û–í–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ---
# –û–ø—Ä–µ–¥–µ–ª—è–µ–º –±–∞–∑–æ–≤—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é, –≥–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è —ç—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç, –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –∞–±—Å–æ–ª—é—Ç–Ω—ã—Ö –ø—É—Ç–µ–π.
BASE_DIR=$(pwd)

# –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è —Å –∏—Å—Ö–æ–¥–Ω—ã–º –∫–æ–¥–æ–º –¥–ª—è –∫–æ–º–ø–∏–ª—è—Ü–∏–∏
CODE_DIR="$BASE_DIR/post_commander/code"

# –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –¥–ª—è "–≥–æ—Ç–æ–≤—ã—Ö" —Ñ–∞–π–ª–æ–≤ –ø–µ—Ä–µ–¥ –∏—Ö –ø–µ—Ä–µ–Ω–æ—Å–æ–º –≤ live-build
READY_DIR="$BASE_DIR/post_commander/ready"

# –¶–µ–ª–µ–≤–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –¥–ª—è —Å–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –±–∏–Ω–∞—Ä–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
TARGET_INCLUDE_DIR="$READY_DIR/usr/local/bin/edge"

# –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –≤ live-build –¥–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤ –≤ –∫–æ—Ä–Ω–µ–≤—É—é —Å–∏—Å—Ç–µ–º—É chroot
CHROOT_INCLUDES_DIR="$BASE_DIR/live-build/config/includes.chroot"

PACKAGES="$BASE_DIR/live-build/config/package-lists"

echo "üöÄ –ù–∞—á–∞–ª–æ —Å–±–æ—Ä–∫–∏ –∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ –ü–û..."

# 1. –ü–µ—Ä–µ—Ö–æ–¥ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é —Å –∏—Å—Ö–æ–¥–Ω—ã–º –∫–æ–¥–æ–º –∏ –∑–∞–ø—É—Å–∫ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏
echo "üìÇ –ü–µ—Ä–µ—Ö–æ–¥ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é: $CODE_DIR"
cd "$CODE_DIR"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —Å–∫—Ä–∏–ø—Ç —Å–±–æ—Ä–∫–∏
if [ ! -f "build_software.sh" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: –°–∫—Ä–∏–ø—Ç 'build_software.sh' –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ $CODE_DIR"
    exit 1
fi

echo "üõ†Ô∏è  –ó–∞–ø—É—Å–∫ —Å–∫—Ä–∏–ø—Ç–∞ —Å–±–æ—Ä–∫–∏ 'build_software.sh'..."
# –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ–º –ø—Ä–∞–≤–∞ –Ω–∞ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–ª—è —Å–∫—Ä–∏–ø—Ç–∞ —Å–±–æ—Ä–∫–∏
chmod +x build_software.sh
# –ó–∞–ø—É—Å–∫–∞–µ–º —Å–∫—Ä–∏–ø—Ç
./build_software.sh
echo "‚úÖ –°–±–æ—Ä–∫–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞."

# 2. –ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ —Å–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ –≤ "–≥–æ—Ç–æ–≤—É—é" –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
echo "üì¶ –ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ —Å–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤..."

# –°–æ–∑–¥–∞–µ–º —Ü–µ–ª–µ–≤—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –±–∏–Ω–∞—Ä–Ω–∏–∫–æ–≤, –µ—Å–ª–∏ –æ–Ω–∞ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
mkdir -p "$TARGET_INCLUDE_DIR"

# –ò—â–µ–º —Ñ–∞–π–ª—ã –±–µ–∑ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è –≤ —Ç–µ–∫—É—â–µ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ (CODE_DIR) –∏ –ø–µ—Ä–µ–º–µ—â–∞–µ–º –∏—Ö.
# -maxdepth 1: –∏—Å–∫–∞—Ç—å —Ç–æ–ª—å–∫–æ –≤ —Ç–µ–∫—É—â–µ–π –ø–∞–ø–∫–µ, –Ω–µ –∑–∞—Ö–æ–¥—è –≤ –ø–æ–¥–ø–∞–ø–∫–∏.
# -type f: –∏—Å–∫–∞—Ç—å —Ç–æ–ª—å–∫–æ —Ñ–∞–π–ª—ã.
# ! -name "*.*": –∏—Å–∫–∞—Ç—å —Ñ–∞–π–ª—ã, –≤ –∏–º–µ–Ω–∏ –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç —Ç–æ—á–∫–∏ (—Ç.–µ. –±–µ–∑ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è).
# -exec mv -v {} ...: –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∫–æ–º–∞–Ω–¥—É mv –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –Ω–∞–π–¥–µ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞.
find . -maxdepth 1 -type f ! -name "*.*" -exec mv -v {} "$TARGET_INCLUDE_DIR/" \;

echo "‚úÖ –°–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –ø–µ—Ä–µ–º–µ—â–µ–Ω—ã –≤ $TARGET_INCLUDE_DIR"

# –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ –∏—Å—Ö–æ–¥–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é, –æ—Ç–∫—É–¥–∞ –±—ã–ª –∑–∞–ø—É—â–µ–Ω —Å–∫—Ä–∏–ø—Ç
cd "$BASE_DIR"

# 3. –ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –≤—Å–µ—Ö –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ –∏ –ø–∞–ø–æ–∫ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é live-build
echo "üöö –ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –≤ live-build..."

# –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è chroot –≤ live-build, –µ—Å–ª–∏ –æ–Ω–∞ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
mkdir -p "$CHROOT_INCLUDES_DIR"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —á—Ç–æ-–ª–∏–±–æ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ READY_DIR –¥–ª—è –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è
if [ -z "$(ls -A "$READY_DIR")" ]; then
   echo "‚ö†Ô∏è  –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è $READY_DIR –ø—É—Å—Ç–∞. –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —à–∞–≥ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è."
else
   # –ö–æ–ø–∏—Ä—É–µ–º –≤—Å–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∏–∑ READY_DIR –≤ CHROOT_INCLUDES_DIR.
   # –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ 'cp -a' —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –ø—Ä–∞–≤–∞ –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—É.
   cp -a "$READY_DIR"/* "$CHROOT_INCLUDES_DIR/"
   
   # –û—á–∏—â–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é 'ready' –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
   sudo rm -r "$TARGET_INCLUDE_DIR"/*
   #echo "‚úÖ –§–∞–π–ª—ã –∏ –ø–∞–ø–∫–∏ —É—Å–ø–µ—à–Ω–æ –ø–µ—Ä–µ–º–µ—â–µ–Ω—ã –≤ $CHROOT_INCLUDES_DIR"
fi

sudo cp -r post_commander/debian-apps.list.chroot live-build/config/package-lists

echo "üéâ –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω—ã!"
